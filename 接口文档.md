# 图书角小程序接口文档

## 1 规范说明

### 身份验证机制

&emsp;&emsp;本系统依赖小程序从腾讯获取的一次性验证code校验用户身份的合法性，校验通过的用户会获取系统颁发的JWTtoken令盘，令牌中保存有用户的基本信息，令牌有效期为1小时。
&emsp;&emsp;在令牌有效期内，如未做特殊说明用户调用的所有接口都需要上送此令牌。

### 异常返回报文

##### Response

-   Body:

| 参数名           | 说明     | 类型      |
| ------------- | ------ | ------- |
| \_isException\_ | 接口是否异常 | Boolean |
| code          | 错误码    | String  |
| message       | 错误说明   | String  |
| type          | 异常类型   | String  |

注意：所有的错误应答报文状态都不是200（成功），可以依次判断报文是否调用成功。

-   Example:

```javascript
{
    "_isException_": true,
    "code": "login.failed",
    "message": "小程序登陆校验失败",
    "type": "com.ahuang.bookCornerServer.exception.AuthException"
}
```

## 2 接口汇总

| 接口路径                     | 接口作用           | 对应方法                        |
| ------------------------ | -------------- | --------------------------- |
| users/{userNo}           | 新用户绑定          | custBind                    |
| /token                   | 获取token        | CustQueryIsBinded           |
| /books                   | 查询图书列表         | custQueryBookList           |
| /books/{bookId}          | 查询图书详情         | custQueryBookDetail         |
| /books/{bookId}          | 操作图书(借阅、归还、点赞) | custHandleBook              |
| /books/{bookId}/comments | 查询对应图书所有评论     | custQueryBookCommentHistory |
| /books/{bookId}/comments | 评论对应图书         | custCommentBook             |
| books/{bookId}/history   | 查询特定图书借阅历史     | custQueryBookBorrowHistory  |
| users/{userNo}/history   | 查询特定用户借阅图书列表   | custQueryBookBorrowRecord   |

## 3 接口说明

### 3.1 用户操作

#### 3.1.1 新用户绑定（注册）

##### Request

-   Method: **POST**
-   URL:  `/bookCorner/v1/users/{userNo}`
-   Headers：
    -   `Content-Type: application/x-www-form-urlencoded`
    -   `Authorization: Bearer {JWTtoken}`(可选)
-   Body:

| 参数名        | 说明      | 类型     | 是否必输 |
| ---------- | ------- | ------ | ---- |
| userNo     | 员工号     | String | Y    |
| userName   | 员工姓名    | String | Y    |
| nickName   | 员工微信昵称  | String | Y    |
| headImgUrl | 微信头像url | String | Y    |

-   Example:

```javascript
    {
      "userNo": "3693",
      "userName": "黄实",
      "nickName": "阿黄",
      "headImgUrl": ""
    }
```

##### Response

-   Body:

| 参数名      | 说明                | 类型     |
| -------- | ----------------- | ------ |
| isBinded | 该用户是否绑定，0未绑定 1已绑定 | String |
| userNo   | 员工号               | String |
| userName | 员工姓名              | String |
| token    | JWT令牌             | String |

-   Example:

```javascript
    {
        "isBinded": "1",
        "userNo": "3693",
        "userName": "黄实",
        "token": "eyJhbGciOiJIUzUxMiJ9.eyJpZCI6NjEsInVzZXJObyI6IjM2OTMiLCJ1c2VyTmFtZSI6Ium7hOWuniIsIm5pY2tOYW1lIjoi6Zi_6buEIiwiaGVhZEltZ1VybCI6IjEyMzEyMzEyMyIsImlzQWRtaW4iOiIwIiwic3ViIjoib2UwRWowYmVzeHF0aDZtdWo3Mlp6ZllHbU1wMCIsImV4cCI6MTUzMTE1MTc2Mn0.3nhkumvEEBSY4yncYFW7Bl9DKn7JiE4y6r9ssRdcTAFzZCgcWVh0HYI41HF4CPfiwCRUduqdEKQwbSrmt-n7Ug"
    }
```

#### 3.1.2 查询用户是否绑定（登陆）

##### Request

-   Method: **POST**
-   URL:  `bookCorner/v1/token?code={code}`
-   Headers：
    -   `Content-Type: application/x-www-form-urlencoded`
    -   `Authorization: Bearer {JWTtoken}`(可选)
-   Body:

| 参数名  | 说明          | 类型     | 是否必输 |
| ---- | ----------- | ------ | ---- |
| code | 从腾讯获取的一次性令牌 | String | Y    |

-   Example:

```url
    http://localhost:8080/bookCorner/v1/token?code=111
```

##### Response

-   Body:

| 参数名      | 说明                | 类型     |
| -------- | ----------------- | ------ |
| isBinded | 该用户是否绑定，0未绑定 1已绑定 | String |
| userNo   | 员工号               | String |
| userName | 员工姓名              | String |
| token    | JWT令牌             | String |

-   Example:

```javascript
{
  "isBinded": "1",
  "userNo": "3693",
  "userName": "黄实",
  "token": "eyJhbGciOiJIUzUxMiJ9.eyJpZCI6NjgsInVzZXJObyI6IjM2OTMiLCJ1c2VyTmFtZSI6Ium7hOWuniIsIm5pY2tOYW1lIjoi6Zi_6buE5ZCM5a2mXHVEODNEXHVERTA0IiwiaGVhZEltZ1VybCI6Imh0dHBzOi8vd3gucWxvZ28uY24vbW1vcGVuL3ZpXzMyL1EwajRUd0dUZlRKSHZ5OFR1cWtlcDg3eXp0d1I2U1drcVkySllCcVZzYWo3YjRoN1hIM1pDZDdLV0Nab0xvc0xJQTVDNXVxbUpwa2htNTVZM1I0bXhnLzEzMiIsImlzQWRtaW4iOiIwIiwic3ViIjoib2UwRWowYmVzeHF0aDZtdWo3Mlp6ZllHbU1wMCIsImV4cCI6MTUzMTg0MjAyOH0.L2R-TeZjjIDom3WYSG_77soRu_Uj5MwDmLfBmXwqhWAl4wKjfAvzAhD8OpqNg9QB-EyTyGMYoc-4x1QHPOcqAg"
}
```

### 3.2 图书操作

#### 3.2.1 查询图书列表

##### Request

-   Method: **POST**
-   URL:  `/bookCorner/v1/books?num={startNum}&bookName={bookName}&bookType={bookType}&bookStatus={bookStatus}`
-   Headers：
    -   `Content-Type: application/x-www-form-urlencoded`
    -   `Authorization: Bearer {JWTtoken}`
-   Body:

| 参数名        | 说明                        | 类型     | 是否必输 |
| ---------- | ------------------------- | ------ | ---- |
| startNum   | 查询图书的起始号（每一页的页首记录id号）     | String | Y    |
| bookName   | 书名（支持模糊搜索）                | String | N    |
| bookType   | 图书类型    0：党建；1：技术 未上送表示全部 | String | N    |
| bookStatus | 图书状态 0：借出；1：在库 未上送表示全部    | String | N    |

-   Example:

```url
http://localhost:8080/bookCorner/v1/books?num=1&bookName=党&bookType=0&bookStatus=1
```

##### Response

-   Body:

| 参数名                      | 说明                                         | 类型           |
| --------------------------- | -------------------------------------------- | -------------- |
| pageSize                    | 当前页大小                                   | Number         |
| startNum                    | 当前页起始图书id                             | Number         |
| endNum                      | 当前页终止图书id                             | Number         |
| totalPageNum                | 总页数                                       | Number         |
| currentPageNum              | 当前页数                                     | currentPageNum |
| lastPage                    | 是否为最后一页                               | Boolean        |
| bookList                    | 图书列表                                     | Array          |
| &emsp;&emsp; bookId         | 图书id                                       | Number         |
| &emsp;&emsp; bookName       | 图书名                                       | String         |
| &emsp;&emsp;  bookWriter    | 图书作者                                     | String         |
| &emsp;&emsp; bookBrief      | 图书简介                                     | String         |
| &emsp;&emsp; bookType       | 图书类型 0：党建；1：技术                    | String         |
| &emsp;&emsp; bookStatus     | 图书状态 0：借出；1：在库                    | String         |
| &emsp;&emsp; bookBuyer      | 图书购买/捐赠者                              | String         |
| &emsp;&emsp; bookTime       | 购买/捐赠时间                                | String         |
| &emsp;&emsp; bookRemark     | 备注                                         | String         |
| &emsp;&emsp; bookLikeNum    | 点赞数                                       | Number         |
| &emsp;&emsp; bookCommentNum | 评论数                                       | Number         |
| &emsp;&emsp; recTime        | 记录创建时间                                 | String         |
| &emsp;&emsp; isBorrowed     | 当前用户是否正在借阅此书 0 未借阅 1 正在借阅 | String         |
| &emsp;&emsp; isLiked        | 当前用户是否点赞此图书  0 未点赞 1 已点赞    | String         |
| &emsp;&emsp; isCommented    | 当前用户是否评论此图书 0 没有 1 是的         | String         |

-   Example:

```javascript
{
"pageSize": 2,
"startNum": 1,
"endNum": 3,
"totalNum": 3,
"totalPageNum": 1,
"currentPageNum": 1,
"lastPage": true,
"bookList": [
    {
        "bookId": 61,
        "bookName": "基层党组织组织生活创新案例",
        "bookWriter": "中共北京市委组织部           中共北京市委《支部生活》杂志社",
        "bookBrief": "图书简介",
        "bookType": "0",
        "bookStatus": "1",
        "bookSource": "0",
        "bookBuyer": "开发二部",
        "bookTime": "2018-01-23 00:00:00",
        "bookRemark": "党建",
        "bookLikeNum": 0,
        "bookCommentNum": 0,
        "recTime": "2018-02-09 00:00:00",
        "isBorrowed": null,
        "isLiked": null,
        "isCommented": null
    },
    {
        "bookId": 60,
        "bookName": "全面从严治党",
        "bookWriter": "中共中央组织部研究室（政策法规局）",
        "bookBrief": "图书简介",
        "bookType": "0",
        "bookStatus": "1",
        "bookSource": "0",
        "bookBuyer": "开发二部",
        "bookTime": "2018-01-23 00:00:00",
        "bookRemark": "党建",
        "bookLikeNum": 0,
        "bookCommentNum": 0,
        "recTime": "2018-02-09 00:00:00",
        "isBorrowed": null,
        "isLiked": null,
        "isCommented": null
    }
]
}
```
